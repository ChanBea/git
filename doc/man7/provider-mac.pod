=pod

=head1 NAME

provider-mac - The mac library E<lt>-E<gt> provider functions

=head1 SYNOPSIS

=for openssl multiple includes

 #include <openssl/core_names.h>
 #include <openssl/core_dispatch.h>

 /*
  * The following function prototypes don't represent actual C functions
  * but rather the signatures of so-called 'dispatched' functions.
  * To indicate the difference, curly {braces} have been added around
  * the function names.
  *
  * See L<provider-base(7)/Dispatched Functions> for an explanation
  * how to interpret those prototypes.
  */

 /* Context management */
 void *{mac_newctx}(void *provctx);
 void {mac_freectx}(void *mctx);
 void *{mac_dupctx}(void *src);

 /* Encryption/decryption */
 int {mac_init}(void *mctx);
 int {mac_update}(void *mctx, const unsigned char *in, size_t inl);
 int {mac_final}(void *mctx, unsigned char *out, size_t *outl, size_t outsize);

 /* MAC parameter descriptors */
 const OSSL_PARAM *{mac_get_params}(void);
 const OSSL_PARAM *{mac_get_ctx_params}(void);
 const OSSL_PARAM *{mac_set_ctx_params}(void);

 /* MAC parameters */
 int {mac_get_params}(OSSL_PARAM params[]);
 int {mac_get_ctx_params}(void *mctx, OSSL_PARAM params[]);
 int {mac_set_ctx_params}(void *mctx, const OSSL_PARAM params[]);

=head1 DESCRIPTION

This documentation is primarily aimed at provider authors. See L<provider(7)>
for further information.

The MAC operation enables providers to implement mac algorithms and make
them available to applications via the API functions L<EVP_MAC_init(3)>,
L<EVP_MAC_update(3)> and L<EVP_MAC_final(3)>.

All "functions" mentioned here are passed as function pointers between
F<libcrypto> and the provider in B<OSSL_DISPATCH> arrays via
B<OSSL_ALGORITHM> arrays that are returned by the provider's
provider_query_operation() function
(see L<provider-base(7)/Provider Functions>).

All these "functions" have a corresponding function type definition
named B<OSSL_{name}_fn>, and a helper function to retrieve the
function pointer from an B<OSSL_DISPATCH> element named
B<OSSL_FUNC_{name}>.
For example, the "function" {mac_newctx}() has these:

 typedef void *(OSSL_{mac_newctx_fn})(void *provctx);
 static ossl_inline OSSL_{mac_newctx_fn}
     {mac_newctx}(const OSSL_DISPATCH *opf);

B<OSSL_DISPATCH> arrays are indexed by numbers that are provided as
macros in L<openssl-core_dispatch.h(7)>, as follows:

 {mac_newctx}                     OSSL_FUNC_MAC_NEWCTX
 {mac_freectx}                    OSSL_FUNC_MAC_FREECTX
 {mac_dupctx}                     OSSL_FUNC_MAC_DUPCTX

 {mac_init}                       OSSL_FUNC_MAC_INIT
 {mac_update}                     OSSL_FUNC_MAC_UPDATE
 {mac_final}                      OSSL_FUNC_MAC_FINAL

 {mac_get_params}                 OSSL_FUNC_MAC_GET_PARAMS
 {mac_get_ctx_params}             OSSL_FUNC_MAC_GET_CTX_PARAMS
 {mac_set_ctx_params}             OSSL_FUNC_MAC_SET_CTX_PARAMS

 {mac_gettable_params}            OSSL_FUNC_MAC_GETTABLE_PARAMS
 {mac_gettable_ctx_params}        OSSL_FUNC_MAC_GETTABLE_CTX_PARAMS
 {mac_settable_ctx_params}        OSSL_FUNC_MAC_SETTABLE_CTX_PARAMS

A mac algorithm implementation may not implement all of these functions.
In order to be a consistent set of functions, at least the following functions
must be implemented: {mac_newctx}(), {mac_freectx}(), {mac_init}(),
{mac_update}(), {mac_final}().
All other functions are optional.

=head2 Context Management Functions

{mac_newctx}() should create and return a pointer to a provider side
structure for holding context information during a mac operation.
A pointer to this context will be passed back in a number of the other mac
operation function calls.
The parameter I<provctx> is the provider context generated during provider
initialisation (see L<provider(7)>).

{mac_freectx}() is passed a pointer to the provider side mac context in
the I<mctx> parameter.
If it receives NULL as I<mctx> value, it should not do anything other than
return.
This function should free any resources associated with that context.

{mac_dupctx}() should duplicate the provider side mac context in the
I<mctx> parameter and return the duplicate copy.

=head2 Encryption/Decryption Functions

{mac_init}() initialises a mac operation given a newly created provider
side mac context in the I<mctx> parameter.

{mac_update}() is called to supply data for MAC computation of a previously
initialised mac operation.
The I<mctx> parameter contains a pointer to a previously initialised provider
side context.
{mac_update}() may be called multiple times for a single mac operation.

{mac_final}() completes the MAC computation started through previous
{mac_init}() and {mac_update}() calls.
The I<mctx> parameter contains a pointer to the provider side context.
The resulting MAC should be written to I<out> and the amount of data written
to I<*outl>, which should not exceed I<outsize> bytes.
The same expectations apply to I<outsize> as documented for
L<EVP_MAC_final(3)>.

=head2 Mac Parameters

See L<OSSL_PARAM(3)> for further details on the parameters structure used by
these functions.

{mac_get_params}() gets details of parameter values associated with the
provider algorithm and stores them in I<params>.

{mac_set_ctx_params}() sets mac parameters associated with the given
provider side mac context I<mctx> to I<params>.
Any parameter settings are additional to any that were previously set.

{mac_get_ctx_params}() gets details of currently set parameter values
associated with the given provider side mac context I<mctx> and stores them
in I<params>.

{mac_gettable_params}(), {mac_gettable_ctx_params}(), and
{mac_settable_ctx_params}() all return constant B<OSSL_PARAM> arrays
as descriptors of the parameters that {mac_get_params}(),
{mac_get_ctx_params}(), and {mac_set_ctx_params}() can handle,
respectively.

Parameters currently recognised by built-in macs are as follows. Not all
parameters are relevant to, or are understood by all macs:

=over 4

=item "key" (B<OSSL_MAC_PARAM_KEY>) <octet string>

Sets the key in the associated MAC ctx.

=item "iv" (B<OSSL_MAC_PARAM_IV>) <octet string>

Sets the IV of the underlying cipher, when applicable.

=item "custom" (B<OSSL_MAC_PARAM_CUSTOM>) <UTF8 string>

Sets the custom string in the associated MAC ctx.

=item "salt" (B<OSSL_MAC_PARAM_SALT>) <octet string>

Sets the salt of the underlying cipher, when applicable.

=item "xof" (B<OSSL_MAC_PARAM_BLOCK_XOF>) <integer>

Sets XOF mode in the associated MAC ctx.
0 means no XOF mode, 1 means XOF mode.

=item "flags" (B<OSSL_MAC_PARAM_FLAGS>) <integer>

Gets flags associated with the MAC.

=for comment We need to investigate if this is the right approach

=item "cipher" (B<OSSL_MAC_PARAM_CIPHER>) <UTF8 string>

=item "digest" (B<OSSL_MAC_PARAM_DIGEST>) <UTF8 string>

Sets the name of the underlying cipher or digest to be used.
It must name a suitable algorithm for the MAC that's being used.

=item "properties" (B<OSSL_MAC_PARAM_PROPERTIES>) <UTF8 string>

Sets the properties to be queried when trying to fetch the underlying algorithm.
This must be given together with the algorithm naming parameter to be
considered valid.

=item "size" (B<OSSL_MAC_PARAM_SIZE>) <integer>

Can be used to get the resulting MAC size.

With some MAC algorithms, it can also be used to set the size that the
resulting MAC should have.
Allowable sizes are decided within each implementation.

=back

=head1 RETURN VALUES

{mac_newctx}() and {mac_dupctx}() should return the newly created
provider side mac context, or NULL on failure.

{mac_init}(), {mac_update}(), {mac_final}(), {mac_get_params}(),
{mac_get_ctx_params}() and {mac_set_ctx_params}() should return 1 for
success or 0 on error.

{mac_gettable_params}(), {mac_gettable_ctx_params}() and
{mac_settable_ctx_params}() should return a constant B<OSSL_PARAM>
array, or NULL if none is offered.

=head1 SEE ALSO

L<provider(7)>

=head1 HISTORY

The provider MAC interface was introduced in OpenSSL 3.0.

=head1 COPYRIGHT

Copyright 2019 The OpenSSL Project Authors. All Rights Reserved.

Licensed under the Apache License 2.0 (the "License").  You may not use
this file except in compliance with the License.  You can obtain a copy
in the file LICENSE in the source distribution or at
L<https://www.openssl.org/source/license.html>.

=cut
