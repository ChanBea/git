/**********************************************************************
 *   gosthash12t.c                                                    *
 *   Copyright (c) 2013 Demos Ltd., Dmitry L. Olshansky               *
 *                      dolshansky@demos.ru                           *
 *                                                                    *
 *              Tests for GOST R 34.11-2012 gosthash12.c              *
 *       This file is distributed under the same license as OpenSSL   *
 **********************************************************************/
#include <stdio.h>

#if defined(OPENSSL_NO_ENGINE) || defined(OPENSSL_NO_GOST)
int main(int argc, char *argv[])
	{
	printf("No GOST 34.11-2012 support\n");
	return 0;
	}
#else

#include <assert.h>
#include <string.h>
#include <openssl/conf.h>
#include <openssl/evp.h>
#include <openssl/engine.h>

#define MAX_TC_LEN (1024)

typedef struct tc_gost12_
{
	unsigned length;
	unsigned char msg[MAX_TC_LEN];
	unsigned char dgst64[64];
	unsigned char dgst32[32];
} tc_gost12;

tc_gost12 test_cases[] = 
{
	//Test vector #1 from RFC6958
	{
	63,
		{
		0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,
		0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,
		0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,
		0x30,0x31,0x32
		},
		{
		0x1B,0x54,0xD0,0x1A,0x4A,0xF5,0xB9,0xD5,0xCC,0x3D,0x86,0xD6,0x8D,0x28,0x54,0x62,0xB1,0x9A,0xBC,0x24,
		0x75,0x22,0x2F,0x35,0xC0,0x85,0x12,0x2B,0xE4,0xBA,0x1F,0xFA,0x00,0xAD,0x30,0xF8,0x76,0x7B,0x3A,0x82,
		0x38,0x4C,0x65,0x74,0xF0,0x24,0xC3,0x11,0xE2,0xA4,0x81,0x33,0x2B,0x08,0xEF,0x7F,0x41,0x79,0x78,0x91,
		0xC1,0x64,0x6F,0x48
		},
		{
		0x9D,0x15,0x1E,0xEF,0xD8,0x59,0x0B,0x89,0xDA,0xA6,0xBA,0x6C,0xB7,0x4A,0xF9,0x27,0x5D,0xD0,0x51,0x02,
		0x6B,0xB1,0x49,0xA4,0x52,0xFD,0x84,0xE5,0xE5,0x7B,0x55,0x00
		}
	},
	//Test vector #2 from RFC6958
	{
	72,
		{
		0xd1,0xe5,0x20,0xe2,0xe5,0xf2,0xf0,0xe8,0x2c,0x20,0xd1,0xf2,0xf0,0xe8,0xe1,0xee,0xe6,0xe8,0x20,0xe2,
		0xed,0xf3,0xf6,0xe8,0x2c,0x20,0xe2,0xe5,0xfe,0xf2,0xfa,0x20,0xf1,0x20,0xec,0xee,0xf0,0xff,0x20,0xf1,
		0xf2,0xf0,0xe5,0xeb,0xe0,0xec,0xe8,0x20,0xed,0xe0,0x20,0xf5,0xf0,0xe0,0xe1,0xf0,0xfb,0xff,0x20,0xef,
		0xeb,0xfa,0xea,0xfb,0x20,0xc8,0xe3,0xee,0xf0,0xe5,0xe2,0xfb
		},
		{
		0x1E,0x88,0xE6,0x22,0x26,0xBF,0xCA,0x6F,0x99,0x94,0xF1,0xF2,0xD5,0x15,0x69,0xE0,0xDA,0xF8,0x47,0x5A,
		0x3B,0x0F,0xE6,0x1A,0x53,0x00,0xEE,0xE4,0x6D,0x96,0x13,0x76,0x03,0x5F,0xE8,0x35,0x49,0xAD,0xA2,0xB8,
		0x62,0x0F,0xCD,0x7C,0x49,0x6C,0xE5,0xB3,0x3F,0x0C,0xB9,0xDD,0xDC,0x2B,0x64,0x60,0x14,0x3B,0x03,0xDA,
		0xBA,0xC9,0xFB,0x28
		},
		{
		0x9D,0xD2,0xFE,0x4E,0x90,0x40,0x9E,0x5D,0xA8,0x7F,0x53,0x97,0x6D,0x74,0x05,0xB0,0xC0,0xCA,0xC6,0x28,
		0xFC,0x66,0x9A,0x74,0x1D,0x50,0x06,0x3C,0x55,0x7E,0x8F,0x50
		}
	},
	{
	100,
	"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
		{
		0x70,0x7e,0x13,0x12,0x71,0xbf,0x1b,0xc6,0xd1,0xe1,0x2f,0xf8,0x46,0xf1,0x5e,0xcf,0x2b,0xe1,0x79,0x89,
		0x6a,0x88,0x91,0xe7,0x4d,0x63,0xd3,0x8f,0xbf,0xb6,0x4b,0x5a,0x1e,0x00,0x0f,0x41,0xc5,0x11,0x81,0x12,
		0x02,0x19,0x9c,0x7f,0x5c,0xc1,0x11,0x9c,0x92,0xe7,0x48,0x53,0x45,0xea,0x29,0xe5,0xa2,0x72,0x70,0xac,
		0xea,0xaa,0x88,0x54,
		},
		{
		0x75,0x16,0x12,0xba,0x8b,0x06,0x0f,0x1c,0x0c,0x63,0xa2,0x3f,0x65,0x0b,0x07,0x3a,0x56,0xe6,0x0e,0x5d,
		0xbc,0x29,0xa3,0x3a,0x2e,0xc6,0x31,0x0e,0x2b,0xe8,0xba,0xad
		}
	},
	{
	14,
		"message digest",
		{
		0x96,0xb5,0x2f,0x32,0x2e,0x3e,0xcf,0x63,0x48,0xd1,0x77,0x60,0x8e,0x2d,0xdb,0x08,0x43,0x09,0xc1,0x64,
		0x2a,0x94,0x92,0x3c,0x0b,0xc5,0x0e,0x41,0xe4,0xcc,0x50,0xe8,0x51,0xd1,0xdd,0x94,0xe4,0xb7,0xa3,0x5c,
		0x30,0x50,0x3c,0xaf,0x87,0xe3,0xe2,0xac,0x33,0x4e,0x2c,0x80,0x5a,0xdb,0x99,0xb5,0xad,0xb5,0x44,0x3d,
		0xd4,0xac,0x23,0xc8
		},
		0x0d,0x45,0x45,0x1b,0x20,0x04,0x23,0x4d,0xe7,0xfb,0xd2,0x89,0xb8,0x9c,0x66,0x5a,0x49,0x4f,0xfe,0xfe,
		0x93,0xc2,0xff,0x6d,0x6f,0x99,0x67,0x7c,0x99,0x08,0x6b,0xff
	}
};


void test_hash12()
	{
	unsigned char hash[EVP_MAX_MD_SIZE];
	unsigned int len;
	const EVP_MD *md = NULL; 
	int i;
	if ((md = EVP_get_digestbyname("md_gost12_256")) == NULL)
		{
		fprintf(stderr, "failed to load `md_gost12_256'!\n"); 
		return;
		}
	EVP_MD_CTX* ctx = EVP_MD_CTX_create();
	for (i=0; i<sizeof(test_cases)/sizeof(test_cases[0]); i++)
		{
		EVP_DigestInit(ctx, md);
		EVP_DigestUpdate(ctx, test_cases[i].msg, test_cases[i].length);
		EVP_DigestFinal(ctx, hash, &len); 
		assert(len == 32);
		assert(memcmp(test_cases[i].dgst32, hash, len) == 0);	
		}
	if ((md = EVP_get_digestbyname("md_gost12_512")) == NULL)
		{
		fprintf(stderr, "failed to load  `md_gost12_512'!\n"); 
		return;
		}
	EVP_MD_CTX_destroy(ctx);
	ctx = EVP_MD_CTX_create();
	for (i=0; i<sizeof(test_cases)/sizeof(test_cases[0]); i++)
		{
		EVP_DigestInit(ctx, md);
		EVP_DigestUpdate(ctx, test_cases[i].msg, test_cases[i].length);
		EVP_DigestFinal(ctx, hash, &len); 
		assert(len == 64);
		assert(memcmp(test_cases[i].dgst64, hash, len) == 0);	
		}
	}

void load_engine()
	{
	CONF *pConfig = NCONF_new(NULL);
	BIO *bpConf;
	long errLine;
	char sConf[] = 
		"openssl_conf = openssl_def\n"
		"\n"
		"[openssl_def]\n"
		"engines = engine_section\n"
		"\n"
		"[engine_section]\n"
		"gost = gost_section\n"
		"\n"
		"[gost_section]\n"
		"default_algorithms = ALL\n"
		"\n";
	#ifndef OPENSSL_NO_DYNAMIC_ENGINE
	setenv("OPENSSL_ENGINES", "../engines/ccgost", 1);
	#endif
	ERR_load_crypto_strings();
	ENGINE_load_builtin_engines();
	OPENSSL_load_builtin_modules();

	bpConf = BIO_new_mem_buf(sConf, -1);
	if(!NCONF_load_bio(pConfig, bpConf, &errLine))
		{
		fprintf(stderr, "NCONF_load_bio: ErrLine=%ld: %s\n",
			errLine, 
			ERR_error_string(ERR_get_error(), NULL));
			return;
		}
	BIO_free(bpConf);

	if(!CONF_modules_load(pConfig, NULL, 0))
		{
		fprintf(stderr, "CONF_modules_load: %s\n",
			ERR_error_string(ERR_get_error(), NULL));
		}
	ENGINE *e; 
	e = ENGINE_by_id("gost"); 
	if (!e)
		{
		fprintf(stderr, "Can't find gost engine \n"); 
		return; 
		} 
	if (!ENGINE_init(e))
		{
		fprintf(stderr, "Engine initialization failed!\n"); 
		ENGINE_free(e); 
		return; 
		} 
	ENGINE_free(e);
	}
	
int main(int argc, char* argv[])
	{
	printf("Testing GOST 34.11-2012 ");
	load_engine();
	test_hash12();
	printf("passed.\n");
	return 0;
	}
#endif
