/**********************************************************************
 *   gosthash12t.c                                                    *
 *   Copyright (c) 2013 Demos Ltd., Dmitry L. Olshansky               *
 *                      dolshansky@demos.ru                           *
 *                                                                    *
 *              Tests for GOST R 34.11-2012 gosthash12.c              *
 *       This file is distributed under the same license as OpenSSL   *
 **********************************************************************/
#include <stdio.h>

#if defined(OPENSSL_NO_ENGINE) || defined(OPENSSL_NO_GOST)
int main(int argc, char *argv[])
	{
	printf("No GOST 34.11-2012 support\n");
	return 0;
	}
#else

#include <assert.h>
#include <string.h>
#include <openssl/conf.h>
#include <openssl/evp.h>
#include <openssl/engine.h>

//Test vector #1 from RFC6958
unsigned char msg1[] = 
{
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,
0x30,0x31,0x32
};
//512-bit digest
unsigned char dgst1_64[64] = 
{
0x1B,0x54,0xD0,0x1A,0x4A,0xF5,0xB9,0xD5,0xCC,0x3D,0x86,0xD6,0x8D,0x28,0x54,0x62,0xB1,0x9A,0xBC,0x24,
0x75,0x22,0x2F,0x35,0xC0,0x85,0x12,0x2B,0xE4,0xBA,0x1F,0xFA,0x00,0xAD,0x30,0xF8,0x76,0x7B,0x3A,0x82,
0x38,0x4C,0x65,0x74,0xF0,0x24,0xC3,0x11,0xE2,0xA4,0x81,0x33,0x2B,0x08,0xEF,0x7F,0x41,0x79,0x78,0x91,
0xC1,0x64,0x6F,0x48
};
//256-bit digest
unsigned char dgst1_32[32] = 
{
0x9D,0x15,0x1E,0xEF,0xD8,0x59,0x0B,0x89,0xDA,0xA6,0xBA,0x6C,0xB7,0x4A,0xF9,0x27,0x5D,0xD0,0x51,0x02,
0x6B,0xB1,0x49,0xA4,0x52,0xFD,0x84,0xE5,0xE5,0x7B,0x55,0x00,
};
//Test vector #2 from RFC6958
unsigned char msg2[] =
{
0xd1,0xe5,0x20,0xe2,0xe5,0xf2,0xf0,0xe8,0x2c,0x20,0xd1,0xf2,0xf0,0xe8,0xe1,0xee,0xe6,0xe8,0x20,0xe2,
0xed,0xf3,0xf6,0xe8,0x2c,0x20,0xe2,0xe5,0xfe,0xf2,0xfa,0x20,0xf1,0x20,0xec,0xee,0xf0,0xff,0x20,0xf1,
0xf2,0xf0,0xe5,0xeb,0xe0,0xec,0xe8,0x20,0xed,0xe0,0x20,0xf5,0xf0,0xe0,0xe1,0xf0,0xfb,0xff,0x20,0xef,
0xeb,0xfa,0xea,0xfb,0x20,0xc8,0xe3,0xee,0xf0,0xe5,0xe2,0xfb
};

unsigned char dgst2_64[64] = 
{
0x1E,0x88,0xE6,0x22,0x26,0xBF,0xCA,0x6F,0x99,0x94,0xF1,0xF2,0xD5,0x15,0x69,0xE0,0xDA,0xF8,0x47,0x5A,
0x3B,0x0F,0xE6,0x1A,0x53,0x00,0xEE,0xE4,0x6D,0x96,0x13,0x76,0x03,0x5F,0xE8,0x35,0x49,0xAD,0xA2,0xB8,
0x62,0x0F,0xCD,0x7C,0x49,0x6C,0xE5,0xB3,0x3F,0x0C,0xB9,0xDD,0xDC,0x2B,0x64,0x60,0x14,0x3B,0x03,0xDA,
0xBA,0xC9,0xFB,0x28
};

unsigned char dgst2_32[32] =
{
0x9D,0xD2,0xFE,0x4E,0x90,0x40,0x9E,0x5D,0xA8,0x7F,0x53,0x97,0x6D,0x74,0x05,0xB0,0xC0,0xCA,0xC6,0x28,
0xFC,0x66,0x9A,0x74,0x1D,0x50,0x06,0x3C,0x55,0x7E,0x8F,0x50
};

void test_hash12()
	{
	unsigned char hash[EVP_MAX_MD_SIZE];
	unsigned int len;
	const EVP_MD *md = NULL; 
	
	if ((md = EVP_get_digestbyname("md_gost12_256")) == NULL)
		{
		fprintf(stderr, "failed to load `md_gost12_256'!\n"); 
		return;
		}
	EVP_MD_CTX* ctx = EVP_MD_CTX_create();
	EVP_DigestInit(ctx, md);
	EVP_DigestUpdate(ctx, msg1, sizeof(msg1));
	EVP_DigestFinal(ctx, hash, &len); 
	assert(len == 32);
	assert(memcmp(dgst1_32, hash, len) == 0);
	EVP_DigestInit(ctx, md);
	EVP_DigestUpdate(ctx, msg2, sizeof(msg2));
	EVP_DigestFinal(ctx, hash, &len); 
	assert(memcmp(dgst2_32, hash, len) == 0);
	
	if ((md = EVP_get_digestbyname("md_gost12_512")) == NULL)
		{
		fprintf(stderr, "failed to load  `md_gost12_512'!\n"); 
		return;
		}
	EVP_MD_CTX_destroy(ctx);
	ctx = EVP_MD_CTX_create();
	EVP_DigestInit(ctx, md);
	EVP_DigestUpdate(ctx, msg1, sizeof(msg1));
	EVP_DigestFinal(ctx, hash, &len); 
	assert(len == 64);
	assert(memcmp(dgst1_64, hash, len) == 0);
	EVP_DigestInit(ctx, md);
	EVP_DigestUpdate(ctx, msg2, sizeof(msg2));
	EVP_DigestFinal(ctx, hash, &len); 
	assert(memcmp(dgst2_64, hash, len) == 0);
	}

void load_engine()
	{
	CONF *pConfig = NCONF_new(NULL);
	BIO *bpConf;
	long errLine;
	char sConf[] = 
		"openssl_conf = openssl_def\n"
		"\n"
		"[openssl_def]\n"
		"engines = engine_section\n"
		"\n"
		"[engine_section]\n"
		"gost = gost_section\n"
		"\n"
		"[gost_section]\n"
		"default_algorithms = ALL\n"
		"\n";
	#ifndef OPENSSL_NO_DYNAMIC_ENGINE
	setenv("OPENSSL_ENGINES", "../engines/ccgost", 1);
	#endif
	ERR_load_crypto_strings();
	ENGINE_load_builtin_engines();
	OPENSSL_load_builtin_modules();

	bpConf = BIO_new_mem_buf(sConf, -1);
	if(!NCONF_load_bio(pConfig, bpConf, &errLine))
		{
		fprintf(stderr, "NCONF_load_bio: ErrLine=%ld: %s\n",
			errLine, 
			ERR_error_string(ERR_get_error(), NULL));
			return;
		}
	BIO_free(bpConf);

	if(!CONF_modules_load(pConfig, NULL, 0))
		{
		fprintf(stderr, "CONF_modules_load: %s\n",
			ERR_error_string(ERR_get_error(), NULL));
		}
	ENGINE *e; 
	e = ENGINE_by_id("gost"); 
	if (!e)
		{
		fprintf(stderr, "Can't find gost engine \n"); 
		return; 
		} 
	if (!ENGINE_init(e))
		{
		fprintf(stderr, "Engine initialization failed!\n"); 
		ENGINE_free(e); 
		return; 
		} 
	ENGINE_free(e);
	}
	
int main(int argc, char* argv[])
	{
	printf("Testing GOST 34.11-2012 ");
	load_engine();
	test_hash12();
	printf("passed.\n");
	return 0;
	}
#endif
